{% extends "layout.html" %}
{% block title %}Tüm Biletler{% endblock %}

{% block content %}
<h2>Tüm Biletler (Admin Panel)</h2>

<p>
    <span class="badge bg-warning">Açık</span>
    <span class="badge bg-info">Yanıtlandı</span>
    <span class="badge bg-success">Kapandı</span>    
</p>

{% for bilet in biletler %}
<div class="card mb-3">
   <div class="card-body">
        <h5 class="card-title">{{ bilet.subject }}</h5>
        <h6 class="card-subtitle text-muted mb-2">From: Kullanıcı #{{ bilet.user_id }} ({{ bilet.user.username if bilet.user else 'Bilinmiyor' }})</h6>
        
        <span class="badge 
        {% if bilet.status == 'Açık' %}bg-warning
        {% elif bilet.status == 'Yanıtlandı' %}bg-info
        {% elif bilet.status == 'Kapandı' %}bg-success
        {% endif %}">
            {{ bilet.status }}
        </span>
        
        <p class="card-text mt-2">{{ bilet.description }}</p>
        <small class="text-muted">Oluşturulma: {{bilet.created_at.strftime('%Y-%m-%d %H:%M')}}</small>
        
        <form method="POST" action="{{ url_for('bilet_durum_guncelle', bilet_id=bilet.id) }}" class="mt-3">
            <div class="input-group"> 
                <select name="status" class="form-select">
                    <option value="Açık" {% if bilet.status == "Açık" %}selected{% endif %}>Açık</option>
                    <option value="Yanıtlandı" {% if bilet.status == "Yanıtlandı" %}selected{% endif %}>Yanıtlandı</option>
                    <option value="Kapandı" {% if bilet.status == "Kapandı" %}selected{% endif %}>Kapandı</option>
                </select>
                <button type="submit" class="btn btn-primary">Güncelle</button>
            </div>
        </form>
        <form method="POST" action="{{ url_for('biletcevapla', bilet_id=bilet.id) }}" class="mt-4">
            {{forms[bilet.id].hidden_tag()}}
            <div class="mb-3">
                {{ forms[bilet.id].description.label(class="form-label") }}
                {{ forms[bilet.id].description(class="form-control", rows=4) }}
                {% for error in forms[bilet.id].description.errors %}
                    <div class="text-danger">{{error}}</div>
                {% endfor %}
            </div>
           {{ forms[bilet.id].submit( class="btn btn-success") }}
        </form>
        <a href="{{ url_for('ticket_detail', ticket_id=bilet.id) }}" class="btn btn-sm btn-secondary mt-2">Mesajlara Git</a>
   </div>
</div>
{% else %}
    <p>Gösterilecek bilet bulunmamaktadır.</p>
{% endfor %}
{% endblock %}